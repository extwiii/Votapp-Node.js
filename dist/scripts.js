function isLoggedIn(e,t,o){if(e.isAuthenticated())return o();t.redirect("/login")}function setOptions(e){console.log("------"+e);for(var t={},o=[],r=0;r<e.length;r++)console.log(e[r].length),e[r]&&(t.name=e[r],t.vote=0,o.push(t),t={});return console.log(e),o}var express=require("express"),app=express(),port=process.env.PORT||8080,mongoose=require("mongoose");mongoose.Promise=Promise;var passport=require("passport"),flash=require("connect-flash"),morgan=require("morgan"),cookieParser=require("cookie-parser"),bodyParser=require("body-parser"),session=require("express-session"),configDB=require("./config/database.js");mongoose.connect(configDB.url),require("./config/passport")(passport),app.use(morgan("dev")),app.use(cookieParser()),app.use(bodyParser.json()),app.use(bodyParser.urlencoded({extended:!0})),app.set("view engine","ejs"),app.use(session({secret:"extwiii",resave:!0,saveUninitialized:!0})),app.use(passport.initialize()),app.use(passport.session()),app.use(flash()),require("./app/routes.js")(app,passport),app.listen(port),console.log("The magic happens on port "+port);var Poll=require("./models/poll");module.exports=function(e,t){e.get("/",function(e,t){Poll.find({},function(o,r){t.render("index.ejs",{polls:r,user:e.user})})}),e.get("/profile",isLoggedIn,function(e,t){t.render("profile.ejs",{user:e.user})}),e.get("/newpoll",isLoggedIn,function(e,t){t.render("newpoll.ejs",{user:e.user})}),e.post("/newpoll",function(e,t){process.nextTick(function(){if(e.user){var o=new Poll;o.id=e.user._id,o.title=e.body.title,o.options=setOptions(e.body.options.split("\r\n")),o.save(function(e){if(e)throw e;console.log("Poll saved successfully!"),t.redirect("/polls/"+o._id)})}})}),e.get("/polls/:id",function(e,t){process.nextTick(function(){e.params.id&&Poll.findOne({_id:e.params.id},function(o,r){if(o)throw o;r?t.render("polls.ejs",{user:e.user,poll:r,url:e.url}):t.redirect("/newpoll")})})}),e.post("/polls/:id",function(e,t){process.nextTick(function(){if(e.body.opt){var o=e.body.opt.slice(7,31);Poll.findOne({"options._id":o},function(r,i){if(r)throw r;for(var s=0;s<i.options.length;s++)String(i.options[s]._id)===o&&i.options[s].vote++;i.save(function(o){if(o)throw o;console.log("Vote saved successfully!"),t.redirect(e.url)})})}})}),e.get("/polls/:id/remove",function(e,t){process.nextTick(function(){e.params.id&&Poll.remove({_id:e.params.id},function(e,o){if(e)throw e;o?t.redirect("/mypolls"):t.redirect("/")})})}),e.get("/mypolls",isLoggedIn,function(e,t){process.nextTick(function(){Poll.find({id:e.user._id},function(e,o){if(e)throw e;o?t.render("mypolls.ejs",{poll:o}):t.redirect("newpoll")})})}),e.get("/logout",function(e,t){e.logout(),t.redirect("/")}),e.get("/login",function(e,t){t.render("login.ejs",{message:e.flash("loginMessage")})}),e.post("/login",t.authenticate("local-login",{successRedirect:"/profile",failureRedirect:"/login",failureFlash:!0})),e.get("/signup",function(e,t){t.render("signup.ejs",{message:e.flash("signupMessage")})}),e.post("/signup",t.authenticate("local-signup",{successRedirect:"/profile",failureRedirect:"/signup",failureFlash:!0})),e.get("/auth/twitter",t.authenticate("twitter",{scope:"email"})),e.get("/auth/twitter/callback",t.authenticate("twitter",{successRedirect:"/profile",failureRedirect:"/"})),e.get("/auth/github",t.authenticate("github",{scope:"email"})),e.get("/auth/github/callback",t.authenticate("github",{successRedirect:"/profile",failureRedirect:"/"}))};var mongoose=require("mongoose"),pollSchema=mongoose.Schema({id:String,title:{type:String,required:!0},options:[{name:String,vote:Number}]});module.exports=mongoose.model("Poll",pollSchema);var mongoose=require("mongoose"),bcrypt=require("bcrypt-nodejs"),userSchema=mongoose.Schema({local:{email:String,password:String},twitter:{id:String,token:String,displayName:String,username:String},github:{id:String,token:String,email:String,name:String}});userSchema.methods.generateHash=function(e){return bcrypt.hashSync(e,bcrypt.genSaltSync(8),null)},userSchema.methods.validPassword=function(e){return bcrypt.compareSync(e,this.local.password)},module.exports=mongoose.model("User",userSchema),module.exports={twitterAuth:{consumerKey:process.env.TWITTER_KEY,consumerSecret:process.env.TWITTER_SECRET,callbackURL:"http://localhost:8080/auth/twitter/callback"},githubAuth:{clientID:process.env.GITHUB_ID,clientSecret:process.env.GITHUB_SECRET,callbackURL:"http://localhost:8080/auth/github/callback"}},module.exports={url:process.env.MONGO_VOTING||"mongodb://localhost/votapp"};var LocalStrategy=require("passport-local").Strategy,TwitterStrategy=require("passport-twitter").Strategy,GithubStrategy=require("passport-github2").Strategy,User=require("../app/models/user"),configAuth=require("./auth");module.exports=function(e){e.serializeUser(function(e,t){t(null,e.id)}),e.deserializeUser(function(e,t){User.findById(e,function(e,o){t(e,o)})}),e.use("local-login",new LocalStrategy({usernameField:"email",passwordField:"password",passReqToCallback:!0},function(e,t,o,r){t&&(t=t.toLowerCase()),process.nextTick(function(){User.findOne({"local.email":t},function(t,i){return t?r(t):i?i.validPassword(o)?r(null,i):r(null,!1,e.flash("loginMessage","Oops! Wrong password.")):r(null,!1,e.flash("loginMessage","No user found."))})})})),e.use("local-signup",new LocalStrategy({usernameField:"email",passwordField:"password",passReqToCallback:!0},function(e,t,o,r){t&&(t=t.toLowerCase()),process.nextTick(function(){if(e.user)return r(null,e.user);User.findOne({"local.email":t},function(i,s){if(i)return r(i);if(s)return r(null,!1,e.flash("signupMessage","That email is already taken."));var n=new User;n.local.email=t,n.local.password=n.generateHash(o),n.save(function(e){return e?r(e):r(null,n)})})})})),e.use(new TwitterStrategy({consumerKey:configAuth.twitterAuth.consumerKey,consumerSecret:configAuth.twitterAuth.consumerSecret,callbackURL:configAuth.twitterAuth.callbackURL,passReqToCallback:!0},function(e,t,o,r,i){process.nextTick(function(){User.findOne({"twitter.id":r.id},function(e,o){if(e)return i(e);if(o)return o.twitter.token||(o.twitter.token=t,o.twitter.username=r.username,o.twitter.displayName=r.displayName,o.save(function(e){return e?i(e):i(null,o)})),i(null,o);var s=new User;s.twitter.id=r.id,s.twitter.token=t,s.twitter.username=r.username,s.twitter.displayName=r.displayName,s.save(function(e){return e?i(e):i(null,s)})})})})),e.use(new GithubStrategy({clientID:configAuth.githubAuth.clientID,clientSecret:configAuth.githubAuth.clientSecret,callbackURL:configAuth.githubAuth.callbackURL,passReqToCallback:!0},function(e,t,o,r,i){process.nextTick(function(){User.findOne({"github.id":r.id},function(e,o){if(e)return i(e);if(o)return o.github.token||(o.github.token=t,o.github.username=r.displayName,o.github.email=(r.emails[0].value||"").toLowerCase(),o.save(function(e){return e?i(e):i(null,o)})),i(null,o);var s=new User;s.github.id=r.id,s.github.token=t,s.github.name=r.displayName,s.github.email=(r.emails[0].value||"").toLowerCase(),s.save(function(e){return e?i(e):i(null,s)})})})}))};